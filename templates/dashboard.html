{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard | GasGo{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    @keyframes bounce-subtle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    .animate-bounce-subtle { animation: bounce-subtle 3s infinite ease-in-out; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fade-in 0.8s ease-out forwards; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-8 animate-fade-in">

    <section class="relative bg-wells-navy rounded-[3rem] p-8 md:p-12 text-white overflow-hidden shadow-2xl">
        <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="space-y-2 text-center md:text-left">
                <h2 class="text-3xl md:text-5xl font-black tracking-tighter">
                    Welcome back, <span class="text-wells-green">{{ user.first_name|default:"Partner" }}</span> üëã
                </h2>
                <p class="text-wells-blue font-bold uppercase tracking-widest text-xs">Energy Command Center</p>
            </div>
            <div class="bg-white/10 backdrop-blur-md p-6 rounded-[2rem] border border-white/20 text-center min-w-[150px]">
                <p class="text-[10px] font-black uppercase opacity-60 tracking-widest mb-1">Lifetime Usage</p>
                <p class="text-wells-green font-black text-3xl">{{ total_kg|floatformat:1 }} <span class="text-xs uppercase">kg</span></p>
            </div>
        </div>
        <div class="absolute -right-20 -bottom-20 w-80 h-80 bg-wells-green/20 rounded-full blur-[100px]"></div>
    </section>

    {% if show_recommender %}
    <section class="animate-bounce-subtle">
        <div class="bg-gradient-to-r from-wells-navy to-wells-blue rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden border-4 border-wells-green/30">
            <div class="relative z-10 flex flex-col lg:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-6 text-center lg:text-left">
                    <div class="w-16 h-16 bg-wells-green rounded-2xl flex items-center justify-center text-3xl shadow-lg shrink-0">
                        <i class="fas fa-bell-exclamation animate-pulse"></i>
                    </div>
                    <div>
                        <h4 class="text-xl font-black tracking-tight">Refill Recommended! ‚ö°Ô∏è</h4>
                        <p class="text-white/70 text-sm font-medium">Based on your usage pattern, your {{ last_order.brand }} cylinder is running low.</p>
                    </div>
                </div>
                <a href="{% url 'vendors' %}" class="bg-wells-green hover:bg-white hover:text-wells-navy px-8 py-4 rounded-2xl font-black text-sm uppercase tracking-widest transition-all shadow-xl whitespace-nowrap">
                    Fast Track Order
                </a>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">

        <div class="bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm flex flex-col items-center justify-center relative overflow-hidden group">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">Estimated Level</p>
            <div class="relative inline-flex items-center justify-center">
                <svg class="w-32 h-32 transform -rotate-90">
                    <circle class="text-slate-100" stroke-width="8" stroke="currentColor" fill="transparent" r="58" cx="64" cy="64"/>
                    <circle class="{% if prediction_percentage < 25 %}text-red-500{% else %}text-wells-green{% endif %} transition-all duration-1000"
                            stroke-width="8" stroke-dasharray="364.4" stroke-dashoffset="{{ 364.4|add:prediction_percentage }}"
                            stroke-linecap="round" stroke="currentColor" fill="transparent" r="58" cx="64" cy="64"/>
                </svg>
                <span class="absolute text-3xl font-black text-wells-navy">{{ prediction_percentage }}%</span>
            </div>
            <p class="mt-6 text-[10px] font-black {% if prediction_percentage < 25 %}text-red-500{% else %}text-slate-400{% endif %} uppercase tracking-widest">
                {% if days_left == "--" %}No Orders{% else %}Empty in ~{{ days_left }} Days{% endif %}
            </p>
        </div>

        <div class="lg:col-span-2 bg-white p-8 rounded-[3rem] border border-slate-100 shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Consumption Trend</p>
                <span class="bg-wells-blue/10 text-wells-blue font-black text-[9px] px-3 py-1 rounded-full uppercase">Smart Logic Active</span>
            </div>
            <div class="h-[160px] w-full">
                <canvas id="usageChart"></canvas>
            </div>
        </div>

        <div class="bg-wells-navy p-8 rounded-[3rem] text-white flex flex-col justify-between group hover:bg-wells-blue transition-colors relative overflow-hidden">
            <div class="relative z-10">
                <i class="fas fa-shield-check text-2xl text-wells-green mb-4"></i>
                <h4 class="text-lg font-black tracking-tight leading-tight mb-2">Cylinder Trust‚Ñ¢</h4>
                <p class="text-white/60 text-[11px] leading-relaxed font-medium text-left">Verify safety certificates via QR scan.</p>
            </div>
            <button onclick="simulateScan()" class="relative z-10 w-full bg-white/10 hover:bg-white/20 border border-white/20 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all mt-4">
                Scan QR Code
            </button>
            <i class="fas fa-qrcode absolute -right-4 -bottom-4 text-7xl opacity-5 -rotate-12"></i>
        </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="{% url 'vendors' %}" class="md:col-span-2 bg-wells-green rounded-[3rem] p-10 text-white shadow-xl shadow-wells-green/20 group hover:scale-[1.01] transition-all flex flex-col justify-between min-h-[280px]">
            <div class="flex justify-between items-start">
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-3xl"><i class="fas fa-gas-pump group-hover:rotate-12 transition-transform"></i></div>
                <span class="bg-wells-navy text-white text-[10px] font-black px-4 py-2 rounded-full tracking-widest">PARTNER VENDORS</span>
            </div>
            <div class="text-left">
                <h3 class="text-4xl font-black tracking-tighter mb-2 italic">Refill Now</h3>
                <p class="text-white/80 font-medium text-left">Safe, certified LPG delivered to your kitchen in under 30 minutes.</p>
            </div>
        </a>

        <a href="{% url 'track_order' %}" class="bg-wells-blue rounded-[3rem] p-10 text-white shadow-xl shadow-wells-blue/20 group hover:scale-[1.01] transition-all flex flex-col justify-between min-h-[280px]">
            <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center text-3xl"><i class="fas fa-truck-fast group-hover:translate-x-3 transition-transform"></i></div>
            <div class="text-left">
                <h3 class="text-3xl font-black tracking-tighter mb-2 italic">Track Live</h3>
                <p class="text-white/80 font-medium text-left">Real-time GPS tracking for your active deliveries.</p>
            </div>
        </a>
    </section>

</div>

<script>
    function simulateScan() {
        const btn = event.target;
        btn.innerText = "Accessing Camera...";
        setTimeout(() => {
            alert("Safety Verified: This cylinder is genuine and certified for safe home use.");
            btn.innerText = "Scan QR Code";
        }, 1500);
    }

    const ctx = document.getElementById('usageChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Oct', 'Nov', 'Dec', 'Jan', 'Feb'],
            datasets: [{
                data: [13, 6, 13, 9, 13],
                borderColor: '#48bb3a',
                backgroundColor: 'rgba(72, 187, 58, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 4,
                pointRadius: 4,
                pointBackgroundColor: '#48bb3a'
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { x: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 10 } } }, y: { display: false } },
            maintainAspectRatio: false,
            responsive: true
        }
    });
</script>
{% endblock %}