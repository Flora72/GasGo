{% extends 'base.html' %}
{% load static %}

{% block title %}Available Vendors | GasGo{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
<link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
<link rel="shortcut icon" href="{% static 'images/logo.png' %}" type="image/png">
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places"></script>
<style>
  #map { height: 400px; margin-bottom: 20px; }
  .selected-vendor { margin-top: 10px; font-weight: bold; color: #007bff; }
  .location-filter { margin-bottom: 20px; }
  .location-filter label { margin-right: 10px; }
</style>
{% endblock %}

{% block content %}
<main>
  <section>
    <h1>Choose a nearby vendor</h1>
    <p>Weâ€™ve scanned petrol stations near your current location. Select one to proceed.</p>
  </section>

  <section class="location-filter">
    <form id="location-filter-form">
      <label for="county">County:</label>
      <select id="county" name="county" required>
        <option value="">-- Select County --</option>
        <option value="Nairobi">Nairobi</option>
        <option value="Kiambu">Kiambu</option>
        <option value="Machakos">Machakos</option>
      </select>

      <label for="district">District:</label>
      <select id="district" name="district" required disabled>
        <option value="">-- Select District --</option>
      </select>
    </form>
  </section>

  <section>
    <div id="map"></div>

    <form method="post" action="{% url 'vendors' %}">
      {% csrf_token %}
      <input type="hidden" name="vendor_choice" id="vendor-choice-input">
      <input type="hidden" name="vendor_lat" id="vendor-lat">
      <input type="hidden" name="vendor_lng" id="vendor-lng">
      <div id="selected-vendor-display" class="selected-vendor"></div>

      <p>
        <label for="notes">Final notes (optional)</label><br>
        <textarea name="notes" rows="3" placeholder="Any extra instructions?"></textarea>
      </p>
      <button type="submit" class="btn btn-primary" id="proceed-button" disabled>Proceed to Payment</button>
    </form>
  </section>

  <script>
    function initMap() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const userLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          loadMapAndScan(userLocation);
        }, () => {
          alert("Location access denied. Please enable location services.");
        });
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    }

    function loadMapAndScan(userLocation) {
      const map = new google.maps.Map(document.getElementById("map"), {
        center: userLocation,
        zoom: 14,
      });

      const service = new google.maps.places.PlacesService(map);
      const request = {
        location: userLocation,
        radius: 8000,
        type: "gas_station"
      };

      service.nearbySearch(request, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          results.forEach(place => {
            const marker = new google.maps.Marker({
              map,
              position: place.geometry.location,
              title: place.name
            });

            marker.addListener("click", () => {
              document.getElementById("vendor-choice-input").value = place.name;
              document.getElementById("vendor-lat").value = place.geometry.location.lat();
              document.getElementById("vendor-lng").value = place.geometry.location.lng();
              document.getElementById("selected-vendor-display").textContent = `Selected: ${place.name}`;
              document.getElementById("proceed-button").disabled = false;
            });
          });
        } else {
          alert("No petrol stations found nearby.");
        }
      });
    }

    window.onload = initMap;

    const districtOptions = {
      Nairobi: ["Westlands", "Lang'ata", "Embakasi", "Kasarani", "Starehe"],
      Kiambu: ["Thika", "Ruiru", "Limuru", "Githunguri"],
      Machakos: ["Mlolongo", "Athi River", "Kangundo"]
    };

    const countySelect = document.getElementById('county');
    const districtSelect = document.getElementById('district');

    countySelect.addEventListener('change', () => {
      const selectedCounty = countySelect.value;
      districtSelect.innerHTML = '<option value="">-- Select District --</option>';

      if (districtOptions[selectedCounty]) {
        districtOptions[selectedCounty].forEach(district => {
          const option = document.createElement('option');
          option.value = district;
          option.textContent = district;
          districtSelect.appendChild(option);
        });
        districtSelect.disabled = false;
      } else {
        districtSelect.disabled = true;
      }
    });
  </script>
</main>
{% endblock %}




