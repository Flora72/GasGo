{% extends 'base.html' %}
{% load static %}

{% block title %}Available Vendors | GasGo{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
<link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
<link rel="shortcut icon" href="{% static 'images/logo.png' %}" type="image/png">
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places"></script>
<style>
  #map { height: 400px; margin-bottom: 20px; }
  .selected-vendor { margin-top: 10px; font-weight: bold; color: #007bff; }
  .location-filter { margin-bottom: 20px; }
  .location-filter label { margin-right: 10px; }
</style>
{% endblock %}

{% block content %}
<main>
  <section>
    <h1>Choose a nearby vendor</h1>
    <p>Weâ€™ve scanned petrol stations near your current location. Select one to proceed.</p>
  </section>

  <section class="location-filter">
    <form id="location-filter-form">
      <label for="county">County:</label>
      <select id="county" name="county" required>
        <option value="">-- Select County --</option>
      </select>

      <label for="district">District:</label>
      <select id="district" name="district" required disabled>
        <option value="">-- Select District --</option>
      </select>
    </form>
  </section>

  <section>
    <div id="map"></div>

    <form method="post" action="{% url 'vendors' %}">
      {% csrf_token %}
      <input type="hidden" name="vendor_choice" id="vendor-choice-input">
      <input type="hidden" name="vendor_lat" id="vendor-lat">
      <input type="hidden" name="vendor_lng" id="vendor-lng">
      <div id="selected-vendor-display" class="selected-vendor"></div>

      <p>
        <label for="notes">Final notes (optional)</label><br>
        <textarea name="notes" rows="3" placeholder="Any extra instructions?"></textarea>
      </p>
      <button type="submit" class="btn btn-primary" id="proceed-button" disabled>Proceed to Payment</button>
    </form>
  </section>

<script>
  const districtOptions = {
    Nairobi: ["Westlands", "Lang'ata", "Embakasi", "Kasarani", "Starehe"],
    Kiambu: ["Thika", "Ruiru", "Limuru","Kiambaa"],
    Machakos: ["Machakos", "Mlolongo", "Athi River", "Kangundo"],
    Mombasa: ["Mombasa", "Likoni", "Nyali"],
    Kisumu: ["Kisumu", "Ahero", "Maseno"],
    Nakuru: ["Nakuru", "Naivasha", "Molo"],
    Kakamega: ["Kakamega", "Mumias", "Lugari"],
    Bungoma: ["Bungoma", "Kimilili", "Webuye"],
    Meru: ["Meru", "Maua", "Nkubu"],
    Nyeri: ["Nyeri", "Karatina", "Othaya"],
    Muranga: ["Murang'a", "Kangema", "Kandara"],
    Embu: ["Embu", "Runyenjes", "Siakago"],
    Kirinyaga: ["Kerugoya", "Kutus", "Wanguru"],
    Nyandarua: ["Ol Kalou", "Engineer", "Njabini"],
    Laikipia: ["Nanyuki", "Rumuruti", "Nyahururu"],
    Uasin_Gishu: ["Eldoret", "Turbo", "Moiben"],
    Trans_Nzoia: ["Kitale", "Endebess", "Kiminini"],
    Nandi: ["Kapsabet", "Nandi Hills", "Mosoriot"],
    Kericho: ["Kericho", "Litein", "Sosiot"],
    Bomet: ["Bomet", "Sotik", "Mulot"],
    Kisii: ["Kisii", "Nyamira", "Ogembo"],
    Migori: ["Migori", "Awendo", "Rongo"],
    Homa_Bay: ["Homa Bay", "Mbita", "Oyugis"],
    Siaya: ["Siaya", "Bondo", "Ugunja"],
    Busia: ["Busia", "Malaba", "Nambale"],
    Vihiga: ["Vihiga", "Luanda", "Mbale"],
    Taita_Taveta: ["Voi", "Wundanyi", "Taveta"],
    Kwale: ["Kwale", "Ukunda", "Msambweni"],
    Kilifi: ["Kilifi", "Malindi", "Kaloleni"],
    Lamu: ["Lamu", "Mokowe", "Hindi"],
    Tana_River: ["Hola", "Garsen", "Bura"],
    Garissa: ["Garissa", "Dadaab", "Modogashe"],
    Wajir: ["Wajir", "Habaswein", "Griftu"],
    Mandera: ["Mandera", "Elwak", "Takaba"],
    Marsabit: ["Marsabit", "Moyale", "Sololo"],
    Turkana: ["Lodwar", "Kakuma", "Lokichogio"],
    Samburu: ["Maralal", "Baragoi", "Wamba"],
    Isiolo: ["Isiolo", "Kinna", "Garbatulla"],
    Tharaka_Nithi: ["Chuka", "Tharaka", "Marimanti"],
    Kitui: ["Kitui", "Mwingi", "Mutomo"],
    Makueni: ["Wote", "Makindu", "Emali"],
    Narok: ["Narok", "Kilgoris", "Suswa"],
    Kajiado: ["Kajiado", "Ngong", "Kitengela"],
    Nyamira: ["Nyamira", "Keroka", "Ekerenyo"],
    Elgeyo_Marakwet: ["Iten", "Kapsowar", "Chepkorio"],
    West_Pokot: ["Kapenguria", "Chepareria", "Sigor"]
  };

  const countySelect = document.getElementById('county');
  const districtSelect = document.getElementById('district');

  Object.keys(districtOptions).forEach(county => {
    const option = document.createElement('option');
    option.value = county;
    option.textContent = county.replace(/_/g, " ");
    countySelect.appendChild(option);
  });

  countySelect.addEventListener('change', () => {
    const selectedCounty = countySelect.value;
    districtSelect.innerHTML = '<option value="">-- Select District --</option>';

    if (districtOptions[selectedCounty]) {
      districtOptions[selectedCounty].forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        districtSelect.appendChild(option);
      });
      districtSelect.disabled = false;
    } else {
      districtSelect.disabled = true;
    }
  });

  function loadMapAndScan(userLocation) {
    const map = new google.maps.Map(document.getElementById("map"), {
      center: userLocation,
      zoom: 14,
    });

    const service = new google.maps.places.PlacesService(map);
    const request = {
      location: userLocation,
      radius: 8000,
      type: "gas_station"
    };

    service.nearbySearch(request, (results, status) => {
      if (status === google.maps.places.PlacesServiceStatus.OK) {
        results.forEach(place => {
          const marker = new google.maps.Marker({
            map,
            position: place.geometry.location,
            title: place.name
          });

          marker.addListener("click", () => {
            document.getElementById("vendor-choice-input").value = place.name;
            document.getElementById("vendor-lat").value = place.geometry.location.lat();
            document.getElementById("vendor-lng").value = place.geometry.location.lng();
            document.getElementById("selected-vendor-display").textContent = `Selected: ${place.name}`;
            document.getElementById("proceed-button").disabled = false;
          });
        });
      } else {
        alert("No petrol stations found nearby.");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    navigator.geolocation.getCurrentPosition(
      position => {
        const userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        console.log("User location:", userLocation);
        loadMapAndScan(userLocation);
      },
      error => {
        console.error("Geolocation error:", error);
        switch (error.code) {
          case error.PERMISSION_DENIED:
            alert("Permission denied. Please allow location access in your browser settings.");
            break;
          case error.POSITION_UNAVAILABLE:
            alert("Location information is unavailable. Try again later.");
            break;
          case error.TIMEOUT:
            alert("Location request timed out. Please refresh and try again.");
            break;
          default:
            alert("An unknown error occurred while accessing location.");
            break;
        }
        const fallbackLocation = {
          lat: {{ user_lat }},
          lng: {{ user_lng }}
        };
        loadMapAndScan(fallbackLocation);
      },
      {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  });
</script>

</main>
{% endblock %}
