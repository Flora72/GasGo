<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Track Order | GasGo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
    <link rel="shortcut icon" href="{% static 'images/logo.png' %}" type="image/png">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>
<header class="header">
    <a href="{% url 'index' %}" class="logo">GasGo</a>
    <nav>
        <ul>
            <li><a href="{% url 'index' %}">Home</a></li>
            <li><a href="{% url 'about' %}">About Us</a></li>
            <li><a href="{% url 'testimonials' %}">Testimonials</a></li>
            <li><a href="{% url 'contact' %}">Contact Us</a></li>
            <li><a href="{% url 'signup' %}">Sign Up</a></li>
            <li><a href="{% url 'login' %}">Login</a></li>
        </ul>
    </nav>
</header>

<main>
    <section>
        <h1>Track your order</h1>
        <p>See your rider on the map and how far they are from you ‚Äî just like tracking a cab.</p>
        <p>
            <label for="id_order">Order ID (optional)</label>
            <input id="id_order" type="text" placeholder="e.g. GGO-2025-00123" />
            <button id="btnTrack" type="button">Track</button>
            <small id="orderHint">No ID? We'll still show a live demo using your location.</small>
        </p>
    </section>

    <section>
        <div id="map" style="width:100%; height:420px; background:#eee;"></div>
        <div id="status" style="margin-top:10px;">
            <p><strong>Status:</strong> <span id="statusText">Getting your location‚Ä¶</span></p>
            <p><strong>Distance to you:</strong> <span id="distance">‚Äî</span> ¬∑ <strong>ETA:</strong> <span id="eta">‚Äî</span></p>
        </div>
        <p style="font-size: 13px; color:#555;">Tip: Allow location access for more accurate tracking. Otherwise we use a Nairobi city center fallback.</p>
    </section>
</main>

<footer>
    <p>Follow Us:</p>
    <nav aria-label="Support and social">
        <a href="mailto:gasgosupport@gmail.com" title="Email GasGo support"><span aria-hidden="true">‚úâÔ∏è</span> <span>Email</span></a>
        <span style="margin:0 6px;">|</span>
        <a href="#" title="X (coming soon)" aria-disabled="true" onclick="return false;"><span aria-hidden="true">ùïè</span> <span>X</span></a>
        <span style="margin:0 6px;">|</span>
        <a href="#" title="Instagram (coming soon)" aria-disabled="true" onclick="return false;"><span aria-hidden="true">üì∏</span> <span>Instagram</span></a>
        <span style="margin:0 6px;">|</span>
        <a href="#" title="Facebook (coming soon)" aria-disabled="true" onclick="return false;"><span aria-hidden="true">f</span> <span>Facebook</span></a>
    </nav>
    <small>&copy; {{ now|default:2025 }} GasGo. All rights reserved.</small>
</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function(){
    // Basic Haversine distance in km
    function distanceKm(a, b){
        var R = 6371; // km
        var dLat = (b.lat - a.lat) * Math.PI / 180;
        var dLon = (b.lng - a.lng) * Math.PI / 180;
        var lat1 = a.lat * Math.PI / 180;
        var lat2 = b.lat * Math.PI / 180;
        var sinDLat = Math.sin(dLat/2);
        var sinDLon = Math.sin(dLon/2);
        var h = sinDLat*sinDLat + Math.cos(lat1)*Math.cos(lat2)*sinDLon*sinDLon;
        var c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
        return R * c;
    }

    function formatEtaKmMins(km, speedKmh){
        if (!isFinite(km) || km <= 0) return 'Arriving';
        var hours = km / Math.max(10, speedKmh || 20);
        var mins = Math.max(1, Math.round(hours * 60));
        return mins + ' min' + (mins>1?'s':'');
    }

    var map = L.map('map');
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Icons
    var riderIcon = L.icon({
        iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    var userIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    var $status = document.getElementById('statusText');
    var $distance = document.getElementById('distance');
    var $eta = document.getElementById('eta');

    // Fallback to Nairobi CBD if geolocation unavailable
    var fallback = { lat: -1.286389, lng: 36.817223 }; // Nairobi CBD

    var userPos = null;
    var riderPos = null;
    var riderMarker = null;
    var userMarker = null;
    var route = null;
    var tickTimer = null;

    function setStatus(s){ $status.textContent = s; }

    function initMapPositions(){
        // If user position unknown, use fallback
        var user = userPos || fallback;
        // Start rider ~3-6km away in a random direction
        var bearing = Math.random() * Math.PI * 2;
        var startKm = 3 + Math.random()*3; // 3-6 km
        var dLat = (startKm/111) * Math.cos(bearing);
        var dLng = (startKm/111) * Math.sin(bearing) / Math.cos(user.lat * Math.PI/180);
        riderPos = { lat: user.lat + dLat, lng: user.lng + dLng };

        map.setView([user.lat, user.lng], 13);

        userMarker = L.marker([user.lat, user.lng], {icon: userIcon}).addTo(map).bindPopup('You');
        riderMarker = L.marker([riderPos.lat, riderPos.lng], {icon: riderIcon}).addTo(map).bindPopup('Your rider');

        if (route) { map.removeLayer(route); }
        route = L.polyline([[riderPos.lat, riderPos.lng], [user.lat, user.lng]], {color: '#0a7b34'}).addTo(map);
        map.fitBounds(route.getBounds(), { padding: [30,30] });

        updateStats();
        startSimulation();
    }

    function updateStats(){
        var user = userPos || fallback;
        var km = distanceKm(riderPos, user);
        $distance.textContent = km.toFixed(2) + ' km';
        $eta.textContent = formatEtaKmMins(km, 20);
    }

    function startSimulation(){
        stopSimulation();
        // Simulate rider moving toward user at ~20 km/h, tick every second
        tickTimer = setInterval(function(){
            var user = userPos || fallback;
            var km = distanceKm(riderPos, user);
            if (km < 0.05){ // Arrived within 50m
                setStatus('Arrived');
                $distance.textContent = '0.00 km';
                $eta.textContent = 'Arrived';
                if (route) { map.removeLayer(route); route = null; }
                clearInterval(tickTimer); tickTimer = null;
                return;
            }
            var stepKm = 20/3600; // km per second at 20 km/h
            // Move fraction toward the user
            var frac = Math.min(0.9, stepKm / Math.max(km, 0.0001));
            riderPos = {
                lat: riderPos.lat + (user.lat - riderPos.lat) * frac,
                lng: riderPos.lng + (user.lng - riderPos.lng) * frac
            };
            riderMarker.setLatLng([riderPos.lat, riderPos.lng]);
            if (route){
                route.setLatLngs([[riderPos.lat, riderPos.lng], [user.lat, user.lng]]);
            }
            updateStats();
        }, 1000);
        setStatus('Rider en route');
    }

    function stopSimulation(){ if (tickTimer){ clearInterval(tickTimer); tickTimer = null; } }

    function geolocateAndStart(){
        if (!navigator.geolocation){
            setStatus('Geolocation not supported. Using city center.');
            initMapPositions();
            return;
        }
        navigator.geolocation.getCurrentPosition(function(pos){
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            setStatus('Location found. Tracking‚Ä¶');
            initMapPositions();
        }, function(){
            setStatus('Could not get your location. Using city center.');
            initMapPositions();
        }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 30000 });
    }

    document.getElementById('btnTrack').addEventListener('click', function(){
        // In a real app, we'd fetch order location by ID. Here we just restart the demo.
        setStatus('Starting tracking‚Ä¶');
        geolocateAndStart();
    });

    // Auto-start demo
    geolocateAndStart();
})();
</script>
</body>
</html>