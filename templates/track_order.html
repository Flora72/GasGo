{% extends 'base.html' %}
{% load static %}

{% block title %}Track Order | GasGo{% endblock %}

{% block head %}
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
  <link rel="stylesheet" href="{% static 'css/track.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places,geometry">
  </script>
  <style>
    #map {
      width: 100%;
      height: 420px;
      background: #eee;
    }
    #status {
      margin-top: 10px;
    }
  </style>
{% endblock %}

{% block content %}
<main>
  <section>
    <h1>Track your order</h1>
    <p>See your rider on the map and how far they are from you — just like tracking a cab.</p>
    <p>
      <label for="id_order">Order ID (optional)</label>
      <input id="id_order" type="text" placeholder="e.g. GGO-2025-00123" value="{{ order.order_id|default:'' }}">
      <button id="btnTrack" type="button">Track</button>
      <small id="orderHint">No ID? We'll show your latest order or a demo.</small>
    </p>

    {% if order %}
      <p><strong>Order ID:</strong> {{ order.order_id }}</p>
      <p><strong>Status:</strong> {{ order.status }}</p>
      <p><strong>Vendor:</strong> {{ order.vendor.name|default:"—" }}</p>
    {% else %}
      <p><em>No active order found. Showing demo tracking.</em></p>
    {% endif %}
  </section>

  <section>
    <div id="map"></div>
    <div id="status">
      <p><strong>Status:</strong> <span id="statusText">Initializing map…</span></p>
      <p><strong>Distance to you:</strong> <span id="distance">—</span> · <strong>ETA:</strong> <span id="eta">—</span></p>
    </div>
    <p style="font-size: 13px; color:#555;">
      Tracking mode: <strong>{{ tracking_mode|capfirst }}</strong> · Tip: Allow location access for better accuracy.
    </p>
  </section>
</main>
{% endblock %}

{% block scripts %}
<script>
  const demoMode = {{ demo_mode|yesno:"true,false" }};
  const trackingMode = "{{ tracking_mode }}";
  const riderLat = {{ rider_lat|default:"null"|safe }};
  const riderLng = {{ rider_lng|default:"null"|safe }};
  const userLat = {{ user_lat|default:"null"|safe }};
  const userLng = {{ user_lng|default:"null"|safe }};

  function initMap() {
    const fallback = { lat: -1.286389, lng: 36.817223 };
    const userLocation = (typeof userLat === "number" && typeof userLng === "number")
      ? { lat: userLat, lng: userLng }
      : fallback;

    const riderLocation = (typeof riderLat === "number" && typeof riderLng === "number")
      ? { lat: riderLat, lng: riderLng }
      : { lat: userLocation.lat + 0.03, lng: userLocation.lng + 0.03 };

    const map = new google.maps.Map(document.getElementById("map"), {
      center: userLocation,
      zoom: 14
    });

    const userMarker = new google.maps.Marker({
      position: userLocation,
      map: map,
      title: "You",
      icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
    });

    const riderMarker = new google.maps.Marker({
      position: riderLocation,
      map: map,
      title: "Your Rider",
      icon: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
    });

    const routeLine = new google.maps.Polyline({
      path: [riderLocation, userLocation],
      geodesic: true,
      strokeColor: "#0a7b34",
      strokeOpacity: 1.0,
      strokeWeight: 2,
      map: map
    });

    const distanceKm = google.maps.geometry.spherical.computeDistanceBetween(
      new google.maps.LatLng(riderLocation),
      new google.maps.LatLng(userLocation)
    ) / 1000;

    document.getElementById("statusText").textContent = "Tracking rider...";
    document.getElementById("distance").textContent = distanceKm.toFixed(2) + " km";
    document.getElementById("eta").textContent = Math.round((distanceKm / 20) * 60) + " mins";
  }

  window.onload = initMap;

  // Enable Track button
  document.getElementById('btnTrack').addEventListener('click', function() {
    const orderId = document.getElementById('id_order').value.trim();
    if (orderId) {
      window.location.href = `/track_order?order_id=${encodeURIComponent(orderId)}`;
    } else {
      alert("Please enter a valid Order ID.");
    }
  });

  document.getElementById('id_order').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('btnTrack').click();
    }
  });
</script>
{% endblock %}
