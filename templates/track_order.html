{% extends 'base.html' %}
{% load static %}
{% block head %}
       <meta charset="UTF-8">
    <title>Track Order | GasGo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="{% static 'images/logo.png' %}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/track.css' %}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
{% endblock %}
{% block content %}
<main>
    <section>
        <h1>Track your order</h1>
        <p>See your rider on the map and how far they are from you — just like tracking a cab.</p>
        <p>
            <label for="id_order">Order ID (optional)</label>
            <input id="id_order" type="text" placeholder="e.g. GGO-2025-00123" />
            <button id="btnTrack" type="button">Track</button>
            <small id="orderHint">No ID? We'll still show a live demo using your location.</small>
        </p>
        {% if order %}
            <p><strong>Order ID:</strong> {{ order.order_id }}</p>
            <p><strong>Status:</strong> {{ order.status }}</p>
            <p><strong>Vendor:</strong> {{ order.vendor.name }}</p>
        {% endif %}
    </section>

    <section>
        <div id="map" style="width:100%; height:420px; background:#eee;"></div>
        <div id="status" style="margin-top:10px;">
            <p><strong>Status:</strong> <span id="statusText">Getting your location…</span></p>
            <p><strong>Distance to you:</strong> <span id="distance">—</span> · <strong>ETA:</strong> <span id="eta">—</span></p>
        </div>
        <p style="font-size: 13px; color:#555;">Tip: Allow location access for more accurate tracking. Otherwise we use a Nairobi city center fallback.</p>
    </section>
</main>
{% endblock %}


{% block content_end %}
<footer>
    <p>Follow Us:</p>
    <nav aria-label="Support and social">
        <a href="#"><i class="fab fa-facebook"></i> Facebook</a>
        <a href="#"><i class="fab fa-instagram"></i> Instagram</a>
        <a href="#"><i class="fab fa-x-twitter"></i> X</a>
    </nav>
    <small>&copy; {{ now|default:2025 }} GasGo. All rights reserved.</small>
</footer>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const demoMode = {{ demo_mode|yesno:"true,false" }};
const riderLat = {{ rider_lat|default:"null"|safe }};
const riderLng = {{ rider_lng|default:"null"|safe }};
const userLat = {{ user_lat|default:"null"|safe }};
const userLng = {{ user_lng|default:"null"|safe }};

(function(){
    function distanceKm(a, b){
        const R = 6371;
        const dLat = (b.lat - a.lat) * Math.PI / 180;
        const dLon = (b.lng - a.lng) * Math.PI / 180;
        const lat1 = a.lat * Math.PI / 180;
        const lat2 = b.lat * Math.PI / 180;
        const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(h), Math.sqrt(1-h));
        return R * c;
    }

    function formatEtaKmMins(km, speedKmh){
        if (!isFinite(km) || km <= 0) return 'Arriving';
        const mins = Math.max(1, Math.round((km / Math.max(10, speedKmh || 20)) * 60));
        return mins + ' min' + (mins > 1 ? 's' : '');
    }

    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const riderIcon = L.icon({
        iconUrl: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-red.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    const userIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
        shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    const $status = document.getElementById('statusText');
    const $distance = document.getElementById('distance');
    const $eta = document.getElementById('eta');

    const fallback = { lat: -1.286389, lng: 36.817223 };
    let userPos = null;
    let riderPos = null;
    let riderMarker = null;
    let userMarker = null;
    let route = null;
    let tickTimer = null;

    function setStatus(s){ $status.textContent = s; }

    function updateStats(){
        const km = distanceKm(riderPos, userPos);
        $distance.textContent = km.toFixed(2) + ' km';
        $eta.textContent = formatEtaKmMins(km, 20);
    }

    function startSimulation(){
        stopSimulation();
        tickTimer = setInterval(() => {
            const km = distanceKm(riderPos, userPos);
            if (km < 0.05){
                setStatus('Arrived');
                $distance.textContent = '0.00 km';
                $eta.textContent = 'Arrived';
                if (route) map.removeLayer(route);
                clearInterval(tickTimer);
                return;
            }
            const stepKm = 20 / 3600;
            const frac = Math.min(0.9, stepKm / Math.max(km, 0.0001));
            riderPos = {
                lat: riderPos.lat + (userPos.lat - riderPos.lat) * frac,
                lng: riderPos.lng + (userPos.lng - riderPos.lng) * frac
            };
            riderMarker.setLatLng([riderPos.lat, riderPos.lng]);
            route.setLatLngs([[riderPos.lat, riderPos.lng], [userPos.lat, userPos.lng]]);
            updateStats();
        }, 1000);
        setStatus('Rider en route');
    }

    function stopSimulation(){ if (tickTimer) clearInterval(tickTimer); }

    function initMapPositions(){
        userPos = userLat && userLng ? { lat: userLat, lng: userLng } : fallback;
        riderPos = riderLat && riderLng ? { lat: riderLat, lng: riderLng } : {
            lat: userPos.lat + 0.03, lng: userPos.lng + 0.03
        };

        map.setView([userPos.lat, userPos.lng], 13);
        userMarker = L.marker([userPos.lat, userPos.lng], {icon: userIcon}).addTo(map).bindPopup('You');
                riderMarker = L.marker([riderPos.lat, riderPos.lng], {icon: riderIcon}).addTo(map).bindPopup('Your rider');

        route = L.polyline([[riderPos.lat, riderPos.lng], [userPos.lat, userPos.lng]], {color: '#0a7b34'}).addTo(map);
        map.fitBounds(route.getBounds(), { padding: [30,30] });

        updateStats();
        startSimulation();
    }

    function geolocateAndStart(){
        if (!navigator.geolocation){
            setStatus('Geolocation not supported. Using city center.');
            initMapPositions();
            return;
        }
        navigator.geolocation.getCurrentPosition(function(pos){
            userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            setStatus('Location found. Tracking…');
            initMapPositions();
        }, function(){
            setStatus('Could not get your location. Using city center.');
            initMapPositions();
        }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 30000 });
    }

    document.getElementById('btnTrack').addEventListener('click', function(){
        setStatus('Starting tracking…');
        if (!demoMode && riderLat !== null && userLat !== null){
            userPos = { lat: userLat, lng: userLng };
            riderPos = { lat: riderLat, lng: riderLng };
            initMapPositions();
        } else {
            geolocateAndStart();
        }
    });

    // Auto-start tracking on page load
    if (!demoMode && riderLat !== null && userLat !== null){
        userPos = { lat: userLat, lng: userLng };
        riderPos = { lat: riderLat, lng: riderLng };
        initMapPositions();
    } else {
        geolocateAndStart();
    }
})();
</script>
{% endblock %}

