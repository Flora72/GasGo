{% extends 'base.html' %}
{% load static %}

{% block title %}GasBot Assistant | GasGo{% endblock %}
{% block page_title %}AI Assistant{% endblock %}

{% block head %}
<style>
    /* Chat Container Styles */
    .chat-container {
        height: calc(100vh - 250px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-log {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    /* Message Bubbles */
    .bot-msg, .user-msg {
        max-width: 80%;
        padding: 16px 20px;
        border-radius: 20px;
        font-size: 14px;
        line-height: 1.5;
        position: relative;
    }

    .bot-msg {
        align-self: flex-start;
        background: white;
        color: #0b2e4d; /* wells-navy */
        border: 1px solid #f1f5f9;
        border-bottom-left-radius: 4px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
    }

    .user-msg {
        align-self: flex-end;
        background: #0b2e4d; /* wells-navy */
        color: white;
        border-bottom-right-radius: 4px;
    }

    /* Typing Animation */
    .dots::after {
        content: '';
        display: inline-block;
        animation: dots 1.5s steps(3, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: ''; }
        40% { content: '.'; }
        60% { content: '..'; }
        80%, 100% { content: '...'; }
    }

    /* Hide scrollbar for clean look */
    .chat-log::-webkit-scrollbar { width: 4px; }
    .chat-log::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-slate-50 rounded-[3rem] border border-slate-100 shadow-inner overflow-hidden flex flex-col h-[70vh]">
        
        <div id="log" class="chat-log p-8">
            <div class="bot-msg">
                <p class="font-black mb-2 text-wells-green text-[10px] uppercase tracking-widest">GasBot Assistant</p>
                Hi! I'm your GasGo AI. I can help with:<br>
                ‚Ä¢ <strong>Ordering</strong> & <strong>Pricing</strong><br>
                ‚Ä¢ <strong>Live Tracking</strong> support<br>
                ‚Ä¢ <strong>Safety</strong> & <strong>Emergencies</strong>
            </div>
        </div>

        <div class="p-6 bg-white border-t border-slate-100">
            <div class="flex flex-wrap gap-2 mb-4">
                <button type="button" data-q="how do i order?" class="px-4 py-2 bg-slate-50 hover:bg-wells-green/10 hover:text-wells-green border border-slate-100 rounded-xl text-xs font-bold text-slate-500 transition-all">How to order?</button>
                <button type="button" data-q="price list" class="px-4 py-2 bg-slate-50 hover:bg-wells-green/10 hover:text-wells-green border border-slate-100 rounded-xl text-xs font-bold text-slate-500 transition-all">Price list</button>
                <button type="button" data-q="track my order" class="px-4 py-2 bg-slate-50 hover:bg-wells-green/10 hover:text-wells-green border border-slate-100 rounded-xl text-xs font-bold text-slate-500 transition-all">Track Order</button>
                <button type="button" data-q="safety tips" class="px-4 py-2 bg-slate-50 hover:bg-wells-green/10 hover:text-wells-green border border-slate-100 rounded-xl text-xs font-bold text-slate-500 transition-all">Safety Tips</button>
            </div>

            <div class="flex gap-4 items-center">
                <input id="msg" type="text" placeholder="Ask me anything about GasGo..." 
                       class="flex-1 bg-slate-50 border-none rounded-2xl px-6 py-4 text-sm focus:ring-2 focus:ring-wells-navy transition outline-none">
                <button id="send" class="w-14 h-14 bg-wells-navy text-white rounded-2xl flex items-center justify-center hover:bg-wells-green hover:shadow-xl transition-all">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="mt-8 flex justify-between items-center px-8">
        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">
            <i class="fas fa-info-circle mr-2 text-wells-blue"></i> Demo AI Assistant
        </p>
        <a href="{% url 'emergency' %}" class="text-[10px] font-black text-red-500 uppercase tracking-widest hover:underline">
            <i class="fas fa-exclamation-triangle mr-2"></i> Report Emergency
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function () {
        const log = document.getElementById('log');
        const msg = document.getElementById('msg');
        const send = document.getElementById('send');

        function append(line, sender = 'bot') {
            const div = document.createElement('div');
            div.className = sender === 'bot' ? 'bot-msg shadow-sm' : 'user-msg shadow-lg';
            
            if (sender === 'bot') {
                div.innerHTML = `<p class="font-black mb-1 text-wells-green text-[10px] uppercase tracking-widest">GasBot Assistant</p>${line}`;
            } else {
                div.textContent = line;
            }
            
            log.appendChild(div);
            log.scrollTo({ top: log.scrollHeight, behavior: 'smooth' });
        }

        function answer(text) {
            const t = (text || '').trim().toLowerCase();
            const has = (...args) => args.some(arg => t.includes(arg));

            let reply = "I didn't quite catch that. Try asking about:<br>‚Ä¢ How to order<br>‚Ä¢ Gas prices<br>‚Ä¢ Live tracking<br>‚Ä¢ Safety tips";

            // Greeting Logic
            if (has('hi', 'hello', 'hey', 'gasbot')) {
                reply = "Hi there! üëã How can I assist you with your LPG needs today?";
            }
            // Ordering Logic
            else if (has('how', 'order', 'buy')) {
                reply = 'To place an order: <br>1. Go to <a href="/orders/" style="color:#48bb3a; font-weight:bold;">Order Gas</a>.<br>2. Choose your brand and size (6kg, 13kg, etc).<br>3. Enter your delivery address.<br>4. Pick a nearby vendor and confirm payment.';
            }
            // Live Tracking Logic
            else if (has('track', 'where', 'rider', 'status')) {
                reply = 'You can track your delivery in real-time on our <a href="/track_order/" style="color:#48bb3a; font-weight:bold;">Live Tracking Map</a>. Ensure you have your Order ID ready.';
            }
            // Pricing Logic (Matching your PRICE_MAP)
            else if (has('price', 'cost', 'how much', 'rates')) {
                reply = "Current Refill Prices:<br>‚Ä¢ <strong>6kg:</strong> KES 1,000 - 1,100<br>‚Ä¢ <strong>13kg:</strong> KES 2,350 - 2,500<br>‚Ä¢ <strong>22.5kg:</strong> KES 4,100 - 4,300<br>‚Ä¢ <strong>50kg:</strong> KES 9,200 - 9,500<br><small>*Prices vary slightly by brand (Total, ProGas, Rubis).</small>";
            }
            // Safety & Emergency Logic
            else if (has('safety', 'smell', 'leak', 'danger')) {
                reply = '<span style="color:#ef4444; font-weight:bold;">‚ö†Ô∏è SAFETY FIRST:</span> If you smell gas, open windows immediately, do not flip any electrical switches, and evacuate. Visit our <a href="/emergency/" style="color:#ef4444; font-weight:bold;">Emergency Page</a> for immediate help.';
            }
            // Vendor Logic
            else if (has('vendor', 'station', 'shop')) {
                reply = 'We partner with certified vendors like TotalEnergies, Rubis, and local partners. After entering your location, we automatically find the <a href="/vendors/" style="color:#48bb3a; font-weight:bold;">nearest station</a> for you.';
            }

            append(reply, 'bot');
        }

        function sendMsg() {
            const q = msg.value.trim();
            if (!q) return;
            append(q, 'user');

            msg.value = '';
            const typingDiv = document.createElement('div');
            typingDiv.className = 'bot-msg typing shadow-sm';
            typingDiv.innerHTML = 'GasBot is thinking<span class="dots"></span>';
            log.appendChild(typingDiv);
            log.scrollTo({ top: log.scrollHeight, behavior: 'smooth' });

            setTimeout(() => {
                if (typingDiv) log.removeChild(typingDiv);
                answer(q);
            }, 1000);
        }

        send.addEventListener('click', sendMsg);
        msg.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMsg(); });

        document.querySelectorAll('button[data-q]').forEach(btn => {
            btn.addEventListener('click', () => {
                msg.value = btn.getAttribute('data-q');
                sendMsg();
            });
        });
    })();
</script>
{% endblock %}